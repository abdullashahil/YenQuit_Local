<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yenquit | Gamified Cessation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
            background: #f0fdfa;
            /* Teal-50 */
            touch-action: manipulation;
            overflow-x: hidden;
            user-select: none;
        }

        .game-canvas {
            background: #1e293b;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            touch-action: none;
        }

        /* Animations */
        @keyframes float {
            0% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }

            100% {
                transform: translateY(0px);
            }
        }

        .float-anim {
            animation: float 3s ease-in-out infinite;
        }

        @keyframes popIn {
            0% {
                transform: scale(0);
                opacity: 0;
            }

            80% {
                transform: scale(1.1);
                opacity: 1;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .badge-pop {
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .btn-press:active {
            transform: scale(0.95);
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        /* Game specific styles */
        #lung-defender-canvas {
            background: linear-gradient(to bottom, #0f172a, #334155);
        }

        #smile-saver-canvas {
            background: linear-gradient(to bottom, #ecfeff, #cffafe);
        }
    </style>
</head>

<body class="text-slate-800 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-teal-600 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2" onclick="app.showHome()">
                <!-- Logo Icon -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h1 class="text-xl font-bold tracking-wider cursor-pointer">Yenquit</h1>
            </div>
            <button onclick="app.showBadges()"
                class="bg-teal-700 hover:bg-teal-800 px-3 py-1 rounded-full text-sm font-semibold flex items-center gap-2 transition btn-press">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-300" viewBox="0 0 20 20"
                    fill="currentColor">
                    <path fill-rule="evenodd"
                        d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                        clip-rule="evenodd" />
                </svg>
                My Badges
            </button>
        </div>
    </header>

    <!-- Floating Exit Button -->
    <a href="/app/learning"
        class="fixed left-4 top-24 z-40 bg-green-500 hover:bg-green-600 text-white p-3 rounded-full shadow-lg transition-all duration-200 hover:scale-110 flex items-center gap-2 group"
        title="Exit to Dashboard">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"
            stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        <span class="hidden group-hover:inline-block text-sm font-semibold whitespace-nowrap">Exit</span>
    </a>

    <!-- Main Content Area -->
    <main id="app-content" class="flex-grow p-4 max-w-4xl mx-auto w-full relative">
        <!-- Views will be injected here via JS -->
    </main>

    <!-- Navigation Bottom (Mobile friendly) -->
    <nav class="bg-white border-t border-slate-200 p-2 md:hidden block fixed bottom-0 w-full z-40">
        <div class="flex justify-around">
            <button onclick="app.showHome()" class="flex flex-col items-center text-teal-600 p-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                <span class="text-xs">Home</span>
            </button>
            <button onclick="app.showBadges()"
                class="flex flex-col items-center text-slate-500 hover:text-teal-600 p-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7" />
                </svg>
                <span class="text-xs">Badges</span>
            </button>
        </div>
    </nav>

    <!-- Modal for Messages -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl transform transition-all scale-100 relative">
            <div id="modal-content" class="text-center">
                <!-- Content injected here -->
            </div>
            <button onclick="app.closeModal()"
                class="mt-6 w-full bg-teal-600 text-white py-3 rounded-xl font-bold hover:bg-teal-700 transition">Continue</button>
        </div>
    </div>

    <!-- Logic -->
    <script>
        // --- Game State & Data ---
        const GameData = {
            badges: [
                { id: 'smoked_novice', name: 'Air Defender', desc: 'Score 500 in Lung Defender', icon: 'üå¨Ô∏è', condition: (s) => s >= 500, type: 'smoked' },
                { id: 'smoked_expert', name: 'Lung Guardian', desc: 'Score 1500 in Lung Defender', icon: 'üõ°Ô∏è', condition: (s) => s >= 1500, type: 'smoked' },
                { id: 'smoked_master', name: 'Smoke Terminator', desc: 'Score 3000 in Lung Defender', icon: 'üå™Ô∏è', condition: (s) => s >= 3000, type: 'smoked' },
                { id: 'smokeless_novice', name: 'Smile Saver', desc: 'Score 500 in Pouch Patrol', icon: 'ü¶∑', condition: (s) => s >= 500, type: 'smokeless' },
                { id: 'smokeless_expert', name: 'Gums Guardian', desc: 'Score 1500 in Pouch Patrol', icon: '‚ú®', condition: (s) => s >= 1500, type: 'smokeless' },
                { id: 'smokeless_master', name: 'Tobacco Trashed', desc: 'Score 3000 in Pouch Patrol', icon: 'üóëÔ∏è', condition: (s) => s >= 3000, type: 'smokeless' }
            ],
            user: {
                badgesEarned: [],
                highScoreSmoked: 0,
                highScoreSmokeless: 0
            }
        };

        // --- Persistence ---
        function loadData() {
            const saved = localStorage.getItem('yenquit_data');
            if (saved) {
                GameData.user = JSON.parse(saved);
            }
        }

        function saveData() {
            localStorage.setItem('yenquit_data', JSON.stringify(GameData.user));
        }

        function checkBadges(score, type) {
            let newBadges = [];
            GameData.badges.forEach(badge => {
                if (badge.type === type && !GameData.user.badgesEarned.includes(badge.id)) {
                    if (badge.condition(score)) {
                        GameData.user.badgesEarned.push(badge.id);
                        newBadges.push(badge);
                    }
                }
            });
            saveData();
            if (newBadges.length > 0) {
                app.showBadgeModal(newBadges);
            }
        }

        // --- Application View Logic ---
        const app = {
            init: () => {
                loadData();
                app.showHome();
            },

            endGame: () => {
                if (typeof LungDefender !== 'undefined') LungDefender.cleanup();
                if (typeof SmileSaver !== 'undefined' && SmileSaver.cleanup) SmileSaver.cleanup(); // assuming we add cleanup to SmileSaver later
                app.showHome();
            },

            showHome: () => {
                const earnedCount = GameData.user.badgesEarned.length;
                const totalCount = GameData.badges.length;

                document.getElementById('app-content').innerHTML = `
                    <div class="space-y-6 pb-20">
                        <!-- Welcome Card -->
                        <div class="bg-gradient-to-r from-teal-500 to-emerald-600 rounded-3xl p-6 text-white shadow-xl">
                            <h2 class="text-2xl font-bold mb-2 text-center">Welcome to Yenquit!</h2>
                            <p class="opacity-90 mb-4 text-center">Master your cravings through gaming. Earn badges and reclaim your health.</p>
                            <div class="flex items-center gap-4 bg-white/20 p-3 rounded-xl backdrop-blur-sm">
                                <div class="text-3xl">üèÜ</div>
                                <div>
                                    <div class="text-sm font-semibold opacity-80">Badges Earned</div>
                                    <div class="text-2xl font-bold">${earnedCount} / ${totalCount}</div>
                                </div>
                            </div>
                        </div>

                        <h3 class="text-xl font-bold text-slate-700 px-1">Choose your Challenge</h3>

                        <!-- Game Card: Smoked -->
                        <div onclick="LungDefender.start()" class="bg-white rounded-2xl shadow-md overflow-hidden cursor-pointer hover:shadow-xl transition transform hover:-translate-y-1 group border border-slate-100">
                            <div class="h-32 bg-slate-800 relative overflow-hidden flex items-center justify-center">
                                <div class="absolute inset-0 opacity-20 bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')]"></div>
                                <div class="text-6xl float-anim relative z-10">üö¨</div>
                                <div class="absolute bottom-2 right-2 text-slate-400 text-xs font-mono">High Score: ${GameData.user.highScoreSmoked}</div>
                            </div>
                            <div class="p-5">
                                <h4 class="text-lg font-bold text-slate-800 mb-1">Lung Defender</h4>
                                <p class="text-sm text-slate-500">Defend the lungs from falling cigarettes. Tap to destroy them!</p>
                                <div class="mt-3 flex gap-2">
                                    <span class="bg-red-100 text-red-600 text-xs px-2 py-1 rounded font-medium">Smoked Tobacco</span>
                                    <span class="bg-blue-100 text-blue-600 text-xs px-2 py-1 rounded font-medium">Arcade Shooter</span>
                                </div>
                            </div>
                        </div>

                        <!-- Game Card: Smokeless -->
                        <div onclick="SmileSaver.start()" class="bg-white rounded-2xl shadow-md overflow-hidden cursor-pointer hover:shadow-xl transition transform hover:-translate-y-1 group border border-slate-100">
                            <div class="h-32 bg-cyan-100 relative overflow-hidden flex items-center justify-center">
                                <div class="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
                                <div class="text-6xl float-anim relative z-10" style="animation-delay: 0.5s">üëÑ</div>
                                <div class="absolute bottom-2 right-2 text-cyan-700 text-xs font-mono">High Score: ${GameData.user.highScoreSmokeless}</div>
                            </div>
                            <div class="p-5">
                                <h4 class="text-lg font-bold text-slate-800 mb-1">Pouch Patrol</h4>
                                <p class="text-sm text-slate-500">Collect healthy habits and trash the tobacco pouches. Keep that smile bright!</p>
                                <div class="mt-3 flex gap-2">
                                    <span class="bg-orange-100 text-orange-600 text-xs px-2 py-1 rounded font-medium">Smokeless Tobacco</span>
                                    <span class="bg-green-100 text-green-600 text-xs px-2 py-1 rounded font-medium">Catcher</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            showBadges: () => {
                let badgesHTML = GameData.badges.map(badge => {
                    const isUnlocked = GameData.user.badgesEarned.includes(badge.id);
                    return `
                        <div class="bg-white rounded-xl p-4 shadow-sm border ${isUnlocked ? 'border-teal-200 bg-teal-50' : 'border-slate-100 opacity-60'} flex items-center gap-4">
                            <div class="w-16 h-16 rounded-full flex items-center justify-center text-3xl ${isUnlocked ? 'bg-white shadow-md' : 'bg-slate-100 grayscale'}">
                                ${badge.icon}
                            </div>
                            <div>
                                <h4 class="font-bold ${isUnlocked ? 'text-teal-900' : 'text-slate-500'}">${badge.name}</h4>
                                <p class="text-xs text-slate-500">${badge.desc}</p>
                                ${isUnlocked ? '<span class="text-xs text-teal-600 font-bold mt-1 inline-block">Unlocked!</span>' : '<span class="text-xs text-slate-400 mt-1 inline-block">Locked</span>'}
                            </div>
                        </div>
                    `;
                }).join('');

                document.getElementById('app-content').innerHTML = `
                    <div class="pb-20">
                        <h2 class="text-2xl font-bold mb-6 text-slate-800">Your Achievements</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${badgesHTML}
                        </div>
                        <button onclick="app.showHome()" class="mt-8 w-full py-3 rounded-xl border border-teal-600 text-teal-600 font-bold hover:bg-teal-50">Back to Games</button>
                    </div>
                `;
            },

            showBadgeModal: (badges) => {
                const modal = document.getElementById('modal');
                const content = document.getElementById('modal-content');

                let html = `<h2 class="text-2xl font-bold text-yellow-500 mb-2">Badge Unlocked!</h2>`;
                badges.forEach(b => {
                    html += `
                        <div class="my-4 flex flex-col items-center badge-pop">
                            <div class="text-6xl mb-2">${b.icon}</div>
                            <div class="text-xl font-bold text-slate-800">${b.name}</div>
                            <div class="text-sm text-slate-500">${b.desc}</div>
                        </div>
                    `;
                });
                html += `<p class="text-teal-600 font-medium mt-4">Great job keeping tobacco away!</p>`;

                content.innerHTML = html;
                modal.classList.remove('hidden');
            },

            closeModal: () => {
                document.getElementById('modal').classList.add('hidden');
            }
        };

        // --- GAME 1: LUNG DEFENDER (Smoked) ---
        const LungDefender = {
            canvas: null,
            ctx: null,
            animationId: null,
            score: 0,
            lives: 3,
            enemies: [],
            particles: [],
            lastSpawn: 0,
            spawnRate: 1500,
            isActive: false,
            handleInputBound: null, // To store the bound event listener
            resizeObserver: null,

            start: () => {
                // Cleanup previous instances just in case
                LungDefender.cleanup();

                app.isActive = false; // Stop other UI
                const container = document.getElementById('app-content');
                container.innerHTML = `
                    <div class="relative w-full h-[80vh] flex flex-col">
                        <div class="flex justify-between items-center mb-2 px-2">
                            <div class="text-white bg-slate-800 px-3 py-1 rounded-full text-sm font-mono">Score: <span id="ld-score">0</span></div>
                            <div class="text-red-500 text-xl" id="ld-lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
                        </div>
                        <canvas id="lung-defender-canvas" class="w-full flex-grow game-canvas cursor-crosshair"></canvas>
                        <div id="ld-overlay" class="absolute inset-0 flex items-center justify-center bg-black/60 hidden rounded-2xl">
                            <div class="text-center text-white p-6 bg-slate-800 rounded-xl shadow-2xl border border-slate-600">
                                <h2 class="text-3xl font-bold text-red-400 mb-2">Game Over</h2>
                                <p class="mb-4 text-slate-300">Tobacco damages lungs over time.</p>
                                <p class="text-2xl font-mono mb-6">Final Score: <span id="ld-final-score">0</span></p>
                                <div class="flex gap-4 justify-center">
                                    <button onclick="LungDefender.restart()" class="bg-teal-500 hover:bg-teal-600 px-6 py-2 rounded-lg font-bold">Retry</button>
                                    <button onclick="app.endGame()" class="bg-slate-600 hover:bg-slate-700 px-6 py-2 rounded-lg font-bold">Menu</button>
                                </div>
                            </div>
                        </div>
                         <div id="ld-intro" class="absolute inset-0 flex items-center justify-center bg-black/80 rounded-2xl z-10">
                            <div class="text-center text-white p-6">
                                <div class="text-5xl mb-4">üå¨Ô∏è vs üö¨</div>
                                <h2 class="text-2xl font-bold mb-2">Lung Defender</h2>
                                <p class="mb-6 opacity-80 max-w-xs mx-auto">Tap the cigarettes before they reach the bottom to protect your lungs!</p>
                                <button onclick="LungDefender.initGame()" class="bg-teal-500 hover:bg-teal-600 px-8 py-3 rounded-xl font-bold text-lg animate-pulse">Start Defending</button>
                            </div>
                        </div>
                    </div>
                `;

                LungDefender.canvas = document.getElementById('lung-defender-canvas');
                LungDefender.ctx = LungDefender.canvas.getContext('2d');

                // Use ResizeObserver for robust layout tracking
                LungDefender.resizeObserver = new ResizeObserver(() => LungDefender.resize());
                LungDefender.resizeObserver.observe(LungDefender.canvas);

                // Initial resize
                LungDefender.resize();
            },

            cleanup: () => {
                LungDefender.isActive = false;
                if (LungDefender.animationId) cancelAnimationFrame(LungDefender.animationId);
                if (LungDefender.resizeObserver) LungDefender.resizeObserver.disconnect();
                if (LungDefender.canvas && LungDefender.handleInputBound) {
                    LungDefender.canvas.removeEventListener('mousedown', LungDefender.handleInputBound);
                    LungDefender.canvas.removeEventListener('touchstart', LungDefender.handleInputBound);
                }
            },

            resize: () => {
                if (!LungDefender.canvas) return;
                const rect = LungDefender.canvas.getBoundingClientRect();
                // Avoid zero-size issues
                if (rect.width === 0 || rect.height === 0) return;

                LungDefender.canvas.width = rect.width;
                LungDefender.canvas.height = rect.height;
                // console.log(`[LungDefender] Resized to ${rect.width}x${rect.height}`);
            },

            initGame: () => {
                document.getElementById('ld-intro').classList.add('hidden');
                LungDefender.score = 0;
                LungDefender.lives = 3;
                LungDefender.enemies = [];
                LungDefender.particles = [];
                LungDefender.spawnRate = 1500;
                LungDefender.isActive = true;
                LungDefender.updateScore();
                LungDefender.updateLives();

                // Cleanup listeners specifically
                if (LungDefender.handleInputBound) {
                    if (LungDefender.canvas) {
                        LungDefender.canvas.removeEventListener('mousedown', LungDefender.handleInputBound);
                        LungDefender.canvas.removeEventListener('touchstart', LungDefender.handleInputBound);
                    }
                }

                // Input handling
                LungDefender.handleInputBound = (e) => {
                    if (!LungDefender.isActive) return;
                    e.preventDefault();
                    // Re-calculate rect on every click to ensure 100% accuracy even if scrolling/shifting happened
                    const rect = LungDefender.canvas.getBoundingClientRect();
                    let clientX, clientY;

                    if (e.touches && e.touches.length > 0) {
                        clientX = e.touches[0].clientX;
                        clientY = e.touches[0].clientY;
                    } else {
                        clientX = e.clientX;
                        clientY = e.clientY;
                    }

                    const x = clientX - rect.left;
                    const y = clientY - rect.top;
                    LungDefender.handleClick(x, y);
                };

                LungDefender.canvas.addEventListener('mousedown', LungDefender.handleInputBound);
                LungDefender.canvas.addEventListener('touchstart', LungDefender.handleInputBound, { passive: false });

                LungDefender.loop();
            },

            restart: () => {
                document.getElementById('ld-overlay').classList.add('hidden');
                LungDefender.initGame();
            },

            handleClick: (x, y) => {
                for (let i = LungDefender.enemies.length - 1; i >= 0; i--) {
                    const e = LungDefender.enemies[i];

                    // Rectangular Hitbox for better vertical detection
                    // Cigarette is vertical. Give it wide horizontal forgiveness and tall vertical forgiveness.
                    const dx = Math.abs(x - e.x);
                    const dy = Math.abs(y - e.y);

                    // Hitbox: 80px width total (+/- 40), 120px height total (+/- 60)
                    if (dx < 40 && dy < 60) {
                        // Hit!
                        LungDefender.createParticles(e.x, e.y, '#94a3b8'); // Ash color
                        LungDefender.enemies.splice(i, 1);
                        LungDefender.score += 50;
                        LungDefender.updateScore();
                        // Speed up slightly
                        if (LungDefender.spawnRate > 500) LungDefender.spawnRate -= 20;
                        return;
                    }
                }
            },

            createParticles: (x, y, color) => {
                for (let i = 0; i < 8; i++) {
                    LungDefender.particles.push({
                        x: x, y: y,
                        vx: (Math.random() - 0.5) * 10,
                        vy: (Math.random() - 0.5) * 10,
                        life: 1.0,
                        color: color
                    });
                }
            },

            spawnEnemy: () => {
                const margin = 30;
                LungDefender.enemies.push({
                    x: margin + Math.random() * (LungDefender.canvas.width - margin * 2),
                    y: -30,
                    radius: 20,
                    speed: 1 + Math.random() * 2 + (LungDefender.score / 2000), // Scale difficulty
                    type: 'cig'
                });
            },

            updateScore: () => {
                const el = document.getElementById('ld-score');
                if (el) el.innerText = LungDefender.score;
            },

            updateLives: () => {
                const el = document.getElementById('ld-lives');
                if (el) {
                    let hearts = '';
                    for (let i = 0; i < LungDefender.lives; i++) hearts += '‚ù§Ô∏è';
                    for (let i = LungDefender.lives; i < 3; i++) hearts += 'üñ§';
                    el.innerText = hearts;
                }
            },

            gameOver: () => {
                LungDefender.isActive = false;
                cancelAnimationFrame(LungDefender.animationId);

                // Update High Score
                if (LungDefender.score > GameData.user.highScoreSmoked) {
                    GameData.user.highScoreSmoked = LungDefender.score;
                }
                saveData();
                checkBadges(LungDefender.score, 'smoked');

                document.getElementById('ld-final-score').innerText = LungDefender.score;
                document.getElementById('ld-overlay').classList.remove('hidden');
            },

            loop: (timestamp) => {
                if (!LungDefender.isActive) return;

                if (!LungDefender.lastSpawn) LungDefender.lastSpawn = timestamp;
                if (timestamp - LungDefender.lastSpawn > LungDefender.spawnRate) {
                    LungDefender.spawnEnemy();
                    LungDefender.lastSpawn = timestamp;
                }

                const ctx = LungDefender.ctx;
                const w = LungDefender.canvas.width;
                const h = LungDefender.canvas.height;

                ctx.clearRect(0, 0, w, h);

                // Draw Lungs Background (Abstract)
                ctx.fillStyle = '#1e293b';
                ctx.beginPath();
                ctx.ellipse(w * 0.3, h, w * 0.25, h * 0.4, 0, Math.PI, 0);
                ctx.fill();
                ctx.beginPath();
                ctx.ellipse(w * 0.7, h, w * 0.25, h * 0.4, 0, Math.PI, 0);
                ctx.fill();

                // Update Enemies
                for (let i = LungDefender.enemies.length - 1; i >= 0; i--) {
                    let e = LungDefender.enemies[i];
                    e.y += e.speed;

                    // Draw Cigarette
                    ctx.save();
                    ctx.translate(e.x, e.y);
                    ctx.rotate(Math.PI / 2); // Vertical
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(-15, -5, 30, 10); // Body
                    ctx.fillStyle = '#d97706'; // Filter
                    ctx.fillRect(-15, -5, 10, 10);
                    ctx.fillStyle = '#ef4444'; // Burning tip
                    ctx.fillRect(10, -5, 5, 10);
                    ctx.restore();

                    // Check bounds (Hit lungs)
                    if (e.y > h - 50) {
                        LungDefender.enemies.splice(i, 1);
                        LungDefender.lives--;
                        LungDefender.updateLives();
                        // Screen shake effect logic could go here
                        if (LungDefender.lives <= 0) {
                            LungDefender.gameOver();
                            return;
                        }
                    }
                }

                // Update Particles
                for (let i = LungDefender.particles.length - 1; i >= 0; i--) {
                    let p = LungDefender.particles[i];
                    p.x += p.vx;
                    p.y += p.vy;
                    p.life -= 0.05;

                    ctx.globalAlpha = p.life;
                    ctx.fillStyle = p.color;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 3, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.globalAlpha = 1;

                    if (p.life <= 0) LungDefender.particles.splice(i, 1);
                }

                LungDefender.animationId = requestAnimationFrame(LungDefender.loop);
            }
        };

        // --- GAME 2: POUCH PATROL (Smokeless) ---
        const SmileSaver = {
            canvas: null,
            ctx: null,
            animationId: null,
            score: 0,
            items: [],
            player: { x: 0, width: 60, height: 60, targetX: 0 },
            lastSpawn: 0,
            spawnRate: 1200,
            isActive: false,

            start: () => {
                app.isActive = false;
                const container = document.getElementById('app-content');
                container.innerHTML = `
                    <div class="relative w-full h-[80vh] flex flex-col">
                        <div class="flex justify-between items-center mb-2 px-2">
                            <div class="text-cyan-900 bg-cyan-100 px-3 py-1 rounded-full text-sm font-mono border border-cyan-300">Score: <span id="ss-score">0</span></div>
                            <div class="text-xs text-slate-500 font-bold uppercase tracking-widest">Collect üçé üíß | Avoid ü•´</div>
                        </div>
                        <canvas id="smile-saver-canvas" class="w-full flex-grow game-canvas cursor-pointer border-b-8 border-cyan-600"></canvas>
                        
                        <div id="ss-overlay" class="absolute inset-0 flex items-center justify-center bg-cyan-900/80 hidden rounded-2xl">
                            <div class="text-center text-white p-6 bg-white rounded-xl shadow-2xl border border-cyan-200 w-3/4">
                                <h2 class="text-3xl font-bold text-slate-800 mb-2">Oops!</h2>
                                <p class="mb-4 text-slate-500 text-sm">Smokeless tobacco ruins oral health.</p>
                                <p class="text-2xl font-mono mb-6 text-teal-600">Score: <span id="ss-final-score">0</span></p>
                                <div class="flex flex-col gap-2 justify-center">
                                    <button onclick="SmileSaver.restart()" class="bg-teal-500 hover:bg-teal-600 px-6 py-2 rounded-lg font-bold w-full">Try Again</button>
                                    <button onclick="app.showHome()" class="bg-slate-200 hover:bg-slate-300 text-slate-700 px-6 py-2 rounded-lg font-bold w-full">Exit</button>
                                </div>
                            </div>
                        </div>

                         <div id="ss-intro" class="absolute inset-0 flex items-center justify-center bg-cyan-900/90 rounded-2xl z-10">
                            <div class="text-center text-white p-6">
                                <div class="text-5xl mb-4">ü¶∑</div>
                                <h2 class="text-2xl font-bold mb-2">Pouch Patrol</h2>
                                <p class="mb-6 opacity-80 text-sm mx-auto">Move the Tooth to catch healthy items (Water, Fruit). Avoid the Tobacco Pouches!</p>
                                <button onclick="SmileSaver.initGame()" class="bg-yellow-400 hover:bg-yellow-500 text-yellow-900 px-8 py-3 rounded-xl font-bold text-lg animate-bounce">Start Patrol</button>
                            </div>
                        </div>
                    </div>
                `;

                SmileSaver.canvas = document.getElementById('smile-saver-canvas');
                SmileSaver.ctx = SmileSaver.canvas.getContext('2d');
                SmileSaver.resize();
                window.addEventListener('resize', SmileSaver.resize);

                // Mouse/Touch Move Logic
                const moveHandler = (e) => {
                    if (!SmileSaver.isActive) return;
                    const rect = SmileSaver.canvas.getBoundingClientRect();
                    const clientX = e.clientX || e.touches[0].clientX;
                    SmileSaver.player.targetX = clientX - rect.left;
                };

                SmileSaver.canvas.addEventListener('mousemove', moveHandler);
                SmileSaver.canvas.addEventListener('touchmove', moveHandler, { passive: false });
            },

            resize: () => {
                if (!SmileSaver.canvas) return;
                const rect = SmileSaver.canvas.getBoundingClientRect();
                SmileSaver.canvas.width = rect.width;
                SmileSaver.canvas.height = rect.height;
                SmileSaver.player.targetX = rect.width / 2;
                SmileSaver.player.x = rect.width / 2;
            },

            initGame: () => {
                document.getElementById('ss-intro').classList.add('hidden');
                SmileSaver.score = 0;
                SmileSaver.items = [];
                SmileSaver.spawnRate = 1200;
                SmileSaver.isActive = true;
                SmileSaver.updateScore();
                SmileSaver.loop();
            },

            restart: () => {
                document.getElementById('ss-overlay').classList.add('hidden');
                SmileSaver.initGame();
            },

            spawnItem: () => {
                const w = SmileSaver.canvas.width;
                const typeRand = Math.random();
                let type = 'good'; // üçé, üíß
                let label = 'üçé';

                if (typeRand > 0.6) {
                    type = 'bad'; // ü•´ (Chew can/pouch)
                    label = 'ü•´';
                } else if (typeRand > 0.3) {
                    label = 'üíß';
                }

                SmileSaver.items.push({
                    x: Math.random() * (w - 40) + 20,
                    y: -40,
                    speed: 2 + (SmileSaver.score / 500),
                    type: type,
                    label: label,
                    angle: 0
                });
            },

            updateScore: () => {
                const el = document.getElementById('ss-score');
                if (el) el.innerText = SmileSaver.score;
            },

            gameOver: () => {
                SmileSaver.isActive = false;
                cancelAnimationFrame(SmileSaver.animationId);

                if (SmileSaver.score > GameData.user.highScoreSmokeless) {
                    GameData.user.highScoreSmokeless = SmileSaver.score;
                }
                saveData();
                checkBadges(SmileSaver.score, 'smokeless');

                document.getElementById('ss-final-score').innerText = SmileSaver.score;
                document.getElementById('ss-overlay').classList.remove('hidden');
            },

            loop: (timestamp) => {
                if (!SmileSaver.isActive) return;

                if (!SmileSaver.lastSpawn) SmileSaver.lastSpawn = timestamp;
                if (timestamp - SmileSaver.lastSpawn > SmileSaver.spawnRate) {
                    SmileSaver.spawnItem();
                    SmileSaver.lastSpawn = timestamp;
                    if (SmileSaver.spawnRate > 600) SmileSaver.spawnRate -= 10;
                }

                const ctx = SmileSaver.ctx;
                const w = SmileSaver.canvas.width;
                const h = SmileSaver.canvas.height;

                ctx.clearRect(0, 0, w, h);

                // Update Player Position (Lerp for smoothness)
                SmileSaver.player.x += (SmileSaver.player.targetX - SmileSaver.player.x) * 0.2;
                // Clamp
                if (SmileSaver.player.x < 30) SmileSaver.player.x = 30;
                if (SmileSaver.player.x > w - 30) SmileSaver.player.x = w - 30;

                // Draw Player (Tooth Character)
                ctx.font = '40px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('ü¶∑', SmileSaver.player.x, h - 40);

                // Update Items
                for (let i = SmileSaver.items.length - 1; i >= 0; i--) {
                    let item = SmileSaver.items[i];
                    item.y += item.speed;
                    item.angle += 0.05;

                    // Draw Item
                    ctx.save();
                    ctx.translate(item.x, item.y);
                    ctx.rotate(Math.sin(item.angle) * 0.2);
                    ctx.font = '30px Arial';
                    ctx.fillText(item.label, 0, 0);
                    ctx.restore();

                    // Collision Detection
                    // Simple box/distance check
                    const dy = (h - 40) - item.y;
                    const dx = SmileSaver.player.x - item.x;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    if (dist < 40) {
                        // Caught!
                        if (item.type === 'good') {
                            SmileSaver.score += 50;
                            SmileSaver.updateScore();
                            // Visual feedback
                            ctx.fillStyle = '#4ade80';
                            ctx.beginPath();
                            ctx.arc(item.x, item.y, 20, 0, Math.PI * 2);
                            ctx.fill();
                        } else {
                            // Bad item caught
                            SmileSaver.gameOver();
                            return;
                        }
                        SmileSaver.items.splice(i, 1);
                        continue;
                    }

                    // Missed items
                    if (item.y > h + 20) {
                        // If we miss a healthy item, no penalty, just remove.
                        // If we let a bad item pass, that's GOOD! Bonus points?
                        if (item.type === 'bad') {
                            SmileSaver.score += 10; // Bonus for avoidance
                            SmileSaver.updateScore();
                        }
                        SmileSaver.items.splice(i, 1);
                    }
                }

                SmileSaver.animationId = requestAnimationFrame(SmileSaver.loop);
            }
        };

        // Initialize App
        window.addEventListener('load', app.init);

    </script>
</body>

</html>